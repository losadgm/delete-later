openapi: 3.0.0
info:
  title: YOVI Users API
  description: REST API to manage YOVI application users
  version: 1.0.0
servers:
  - url: http://localhost:3000
    description: Local server

paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: Server running
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  timestamp:
                    type: string

  /api/auth/register:
    post:
      summary: Register new user
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - password
              properties:
                username:
                  type: string
                  example: player1
                email:
                  type: string
                  format: email
                  example: player1@example.com
                password:
                  type: string
                  format: password
                  minLength: 6
                  example: password123
      responses:
        "201":
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User registered successfully
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      username:
                        type: string
                        example: player1
                      email:
                        type: string
                        format: email
                        example: player1@example.com
                      role:
                        type: string
                        enum: [player, admin]
                        example: player
                      createdAt:
                        type: string
                        format: date-time
                        example: "2026-02-14T15:30:00.000Z"
        "400":
          description: Validation error or username/email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                missingFields:
                  value:
                    error: All fields are required
                shortPassword:
                  value:
                    error: Password must be at least 6 characters long
                duplicateUser:
                  value:
                    error: Username or email already exists
                invalidJson:
                  value:
                    error: Invalid JSON
                    message: The request body contains malformed JSON.
                    details: Unexpected token in JSON at position 0

  /api/auth/login:
    post:
      summary: User login
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: player1@example.com
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        "200":
          description: Successful login
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Login successful
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      username:
                        type: string
                        example: player1
                      email:
                        type: string
                        format: email
                        example: player1@example.com
                      role:
                        type: string
                        enum: [player, admin]
                        example: player
        "400":
          description: Missing required fields or invalid JSON
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                missingFields:
                  value:
                    error: Email and password are required
                invalidJson:
                  value:
                    error: Invalid JSON
                    message: The request body contains malformed JSON.
                    details: Unexpected token in JSON at position 0
        "401":
          description: Invalid credentials or user deactivated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalidCredentials:
                  value:
                    error: Invalid credentials
                deactivated:
                  value:
                    error: User deactivated

  /api/auth/profile:
    get:
      summary: Get authenticated user profile
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfile"
        "401":
          description: Unauthorized - Missing, invalid, or expired token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
              examples:
                noToken:
                  value:
                    error: No authentication token provided
                invalidToken:
                  value:
                    error: Invalid token
                    message: Authentication token is invalid.
                expiredToken:
                  value:
                    error: Token expired
                    message: Your session has expired. Please login again.
                userNotFound:
                  value:
                    error: User not found
                    message: Invalid authentication token
        "403":
          description: Forbidden - Account deactivated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
              example:
                error: Account deactivated
                message: Your account has been deactivated. Please contact support.
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: User not found

    put:
      summary: Update user profile
      tags:
        - Authentication
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: newUsername
                email:
                  type: string
                  format: email
                  example: newemail@example.com
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Profile updated successfully
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      username:
                        type: string
                        example: newUsername
                      email:
                        type: string
                        format: email
                        example: newemail@example.com
                      role:
                        type: string
                        enum: [player, admin]
                        example: player
        "400":
          description: Validation error or username/email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                duplicateUsername:
                  value:
                    error: Username already exists
                duplicateEmail:
                  value:
                    error: Email already exists
                userNotFound:
                  value:
                    error: User not found
                invalidJson:
                  value:
                    error: Invalid JSON
                    message: The request body contains malformed JSON.
                    details: Unexpected token in JSON at position 0
                databaseError:
                  value:
                    error: Database error
                    message: Invalid data provided
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "403":
          description: Forbidden - Account deactivated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"

  /api/auth/change-password:
    put:
      summary: Change user password
      tags:
        - Authentication
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                  format: password
                  example: currentPass123
                newPassword:
                  type: string
                  format: password
                  minLength: 6
                  example: newPass456
      responses:
        "200":
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password updated successfully
        "400":
          description: Validation error or incorrect current password
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                missingFields:
                  value:
                    error: Current and new password are required
                shortPassword:
                  value:
                    error: New password must be at least 6 characters long
                incorrectPassword:
                  value:
                    error: Current password is incorrect
                userNotFound:
                  value:
                    error: User not found
                invalidJson:
                  value:
                    error: Invalid JSON
                    message: The request body contains malformed JSON.
                    details: Unexpected token in JSON at position 0
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "403":
          description: Forbidden - Account deactivated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"

  /api/auth/account:
    delete:
      summary: Deactivate user account
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Account deactivated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Account deactivated successfully
        "400":
          description: Error deactivating account
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: User not found
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "403":
          description: Forbidden - Account deactivated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"

  /metrics:
    get:
      summary: Prometheus metrics
      tags:
        - Monitoring
      responses:
        "200":
          description: Metrics in Prometheus format
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP http_request_duration_seconds duration histogram
                  # TYPE http_request_duration_seconds histogram
                  http_request_duration_seconds_bucket{le="0.1"} 100

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Bearer token authentication using JWT

  schemas:
    UserProfile:
      type: object
      properties:
        id:
          type: integer
          example: 1
        username:
          type: string
          example: player1
        email:
          type: string
          format: email
          example: player1@example.com
        role:
          type: string
          enum: [player, admin]
          example: player
        createdAt:
          type: string
          format: date-time
          example: "2026-02-14T15:30:00.000Z"
        lastLogin:
          type: string
          format: date-time
          nullable: true
          example: "2026-02-14T16:00:00.000Z"

    Error:
      type: object
      properties:
        error:
          type: string
          example: Error message
        message:
          type: string
          example: Additional error details
        details:
          type: string
          example: Technical error details

    AuthError:
      type: object
      properties:
        error:
          type: string
          example: Authentication error
        message:
          type: string
          example: Detailed authentication error message
